<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>さじグラム変換</title>
  <style>
    /* Rosé Pine Dawn */
    :root {
      --base:    #faf4ed;
      --surface: #fffaf3;
      --overlay: #f2e9e1;
      --muted:   #9893a5;
      --subtle:  #797593;
      --text:    #575279;
      --love:    #b4637a;
      --gold:    #ea9d34;
      --rose:    #d7827a;
      --hl-low:  #f4ede8;
      --hl-med:  #dfdad9;
      --hl-high: #cecacd;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;
      background: var(--base);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 16px;
      gap: 20px;
    }

    .container {
      width: 100%;
      max-width: 480px;
      background: var(--surface);
      border-radius: 20px;
      box-shadow: 0 2px 16px rgba(87, 82, 121, 0.08);
      overflow: hidden;
    }

    .input-section { padding: 28px 24px 24px; }

    h1 {
      font-size: 1.4rem;
      font-weight: 800;
      color: var(--rose);
      margin-bottom: 24px;
      letter-spacing: 0.04em;
    }

    .field-label {
      display: block;
      font-size: 0.68rem;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    textarea {
      width: 100%;
      min-height: 180px;
      padding: 12px;
      font-size: 0.95rem;
      font-family: inherit;
      color: var(--text);
      background: var(--overlay);
      border: 2px solid var(--hl-med);
      border-radius: 10px;
      resize: vertical;
      line-height: 1.7;
      transition: border-color 0.15s;
    }

    textarea:focus { outline: none; border-color: var(--love); }
    textarea::placeholder { color: var(--muted); }

    .btn {
      display: block;
      width: 100%;
      margin-top: 14px;
      padding: 13px;
      background: var(--love);
      color: #fff;
      font-size: 1rem;
      font-weight: 700;
      font-family: inherit;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: opacity 0.15s;
    }

    .btn:hover  { opacity: 0.88; }
    .btn:active { opacity: 0.75; }

    .result-section {
      padding: 20px 24px 24px;
      background: var(--hl-low);
      border-top: 2px solid var(--hl-med);
    }

    .result-section[hidden] { display: none; }

    .result-label {
      font-size: 0.68rem;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin-bottom: 12px;
    }

    .result-lines { display: flex; flex-direction: column; gap: 8px; }

    .result-line {
      font-size: 0.93rem;
      line-height: 1.5;
      color: var(--subtle);
    }

    .gram      { color: var(--rose); font-weight: 700; }
    .estimated { font-size: 0.78rem; color: var(--muted); }
    .no-conv   { color: var(--muted); }

    .nav {
      width: 100%;
      max-width: 480px;
      font-size: 0.82rem;
      color: var(--muted);
      padding: 0 4px;
    }

    .nav a { color: var(--love); text-decoration: underline; text-underline-offset: 2px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="input-section">
      <h1>さじグラム変換</h1>
      <label class="field-label" for="recipe">レシピを貼り付け</label>
      <textarea id="recipe" placeholder="例：
醤油　大匙1
砂糖　小匙1
ごま油 大さじ1/2
塩 小さじ1/4
鶏もも肉 2枚"></textarea>
      <button class="btn" id="convert-btn">変換</button>
    </div>
    <div class="result-section" id="result-section" hidden>
      <div class="result-label">変換結果</div>
      <div class="result-lines" id="result-lines"></div>
    </div>
  </div>

  <div class="nav">← <a href="index.html">さじグラム（1品計算）に戻る</a></div>

  <script>
    const groups = [
      { gramPerTablespoon: 18, items: ["塩", "みりん", "しょうゆ", "醤油", "しょう油", "蠣油醤", "オイスターソース"] },
      { gramPerTablespoon: 15, items: ["水", "酒", "酢", "日本酒", "紹興酒", "レモン汁", "溶き玉子", "サラダ油", "オリーブオイル", "ごま油", "油"] },
      { gramPerTablespoon:  9, items: ["砂糖", "小麦粉", "片栗粉", "水溶き片栗粉"] },
    ];

    // 最長一致のため length 降順にソート
    const allItems = groups
      .flatMap(g => g.items.map(name => ({ name, gpt: g.gramPerTablespoon })))
      .sort((a, b) => b.name.length - a.name.length);

    // 全角数字・ピリオドを半角に正規化
    function toHalf(s) {
      return s
        .replace(/[０-９]/g, c => String.fromCharCode(c.charCodeAt(0) - 0xFEE0))
        .replace(/．/g, '.');
    }

    // 数量文字列 → float（優先順: 帯分数 > 分数 > 小数/整数）
    function parseAmount(s) {
      let m;
      if ((m = s.match(/^(\d+)と(\d+)\/(\d+)$/))) return +m[1] + +m[2] / +m[3];
      if ((m = s.match(/^(\d+)\/(\d+)$/)))          return +m[1] / +m[2];
      if ((m = s.match(/^(\d+(?:\.\d+)?)$/)))        return parseFloat(m[1]);
      return null;
    }

    function parseLine(rawLine) {
      if (!rawLine.trim()) return null;

      const norm = toHalf(rawLine);

      // 括弧内に既存グラム値 e.g. （5g）(5g)
      const bm = norm.match(/[（(](\d+(?:\.\d+)?)g[）)]/);
      const bracketGrams = bm ? parseFloat(bm[1]) : null;

      // さじ表記を全て検索
      // [大小][さ匙]じ? → 大さじ / 小さじ / 大匙 / 小匙
      const spoonRe = /([大小][さ匙]じ?)((?:\d+と\d+\/\d+|\d+\/\d+|\d+(?:\.\d+)?))/g;
      const hits = [];
      let m;
      while ((m = spoonRe.exec(norm)) !== null) {
        const isTable = m[1].startsWith('大');
        const amount  = parseAmount(m[2]);
        if (amount === null) continue;

        // 調味料マスタ照合（最長一致）
        const found     = allItems.find(it => norm.includes(it.name)) ?? null;
        const estimated = !found;
        const gpt       = found ? found.gpt : 15; // デフォルト: 水相当
        const raw       = amount * (isTable ? 1 : 1 / 3) * gpt;
        const grams     = Math.round(raw * 10) / 10;

        hits.push({ grams, estimated, bracketGrams });
      }

      return { line: rawLine, hits };
    }

    function fmtG(g) {
      return g % 1 === 0 ? String(g) : g.toFixed(1);
    }

    function esc(s) {
      return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function render(parsed) {
      const container = document.getElementById('result-lines');
      container.innerHTML = '';

      for (const item of parsed) {
        if (!item) continue;
        const div = document.createElement('div');
        div.className = 'result-line';

        if (item.hits.length === 0) {
          div.innerHTML = `${esc(item.line)}<span class="no-conv">（変換なし）</span>`;
        } else {
          const parts = item.hits.map(h => {
            const g   = h.bracketGrams !== null ? h.bracketGrams : h.grams;
            const est = h.bracketGrams === null && h.estimated
              ? '<span class="estimated">※推定</span>' : '';
            return `<span class="gram">${fmtG(g)}g</span>${est}`;
          });
          div.innerHTML = `${esc(item.line)} → ${parts.join('、')}`;
        }

        container.appendChild(div);
      }

      document.getElementById('result-section').hidden = false;
    }

    document.getElementById('convert-btn').addEventListener('click', () => {
      const lines = document.getElementById('recipe').value.split('\n');
      render(lines.map(parseLine).filter(Boolean));
    });
  </script>
</body>
</html>
